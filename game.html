<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteor Dodge Game</title>
    <link rel="icon" href="meteorslogo.ico" type="image/x-icon">
    <style>
        :root {
        --orange: #ff6a1a;
        --dark: #232323;
        --light: #fff;
    }
    body {
        margin: 0;
        padding: 0;
        font-family: 'Asimovian', 'Asimovian', sans-serif;
        background: var(--dark);
        color: var(--light);
        min-height: 100vh;
    }
    .container {
        max-width: 700px;
        margin: 60px auto;
        background: rgba(35, 35, 35, 0.92);
        border-radius: 18px;
        box-shadow: 0 8px 32px 0 rgba(0,0,0,0.37);
        padding: 40px 32px 32px 32px;
        text-align: center;
    }
    h1, h2 {
            font-family: 'Orbitron', 'Orbitron', sans-serif; /* Ensure titles use Orbitron font */
        }

    h1 {
        font-size: 2.8rem;
        margin-bottom: 0.5rem;
        letter-spacing: 2px;
        color: var(--orange);
        text-shadow: 0 2px 12px #000;
    }
    h2 {
        font-size: 1.5rem;
        color: #ffb366;
        margin-top: 0;
        margin-bottom: 1.5rem;
    }
    .cta {
        display: inline-block;
        margin-top: 1.5rem;
        padding: 0.7em 2em;
        background: var(--orange);
        color: var(--dark);
        border-radius: 30px;
        font-weight: bold;
        font-size: 1.1rem;
        text-decoration: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.18);
        transition: background 0.2s, color 0.2s;
        font-family: 'Asimovian', 'Asimovian', sans-serif; /* Ensure buttons use Asimovian font */
    }
    .cta:hover {
        background: #fff;
        color: var(--orange);
    }
    @media (max-width: 600px) {
        .container { padding: 20px 8px; }
        h1 { font-size: 2rem; }
    }
    .asimovian-regular {
        font-family: "Asimovian", sans-serif;
        font-weight: 400;
        font-style: normal;
    }

        canvas {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            border: none;
            border-radius: 20px;
            display: block;
            margin: auto;
        }
    </style>
</head>
<body>
    <div class="container" id="intro">
        <h1>Welcome to Meteor Dodge!</h1>
        <p>Use the left and right arrow keys to move the rocket and dodge the meteors. Press the spacebar to shoot lasers and destroy meteors. Your score increases every time you destroy a meteor or successfully dodge one. Good luck!</p>
        <button class="cta" onclick="startGame()">Start Game</button>
    </div>

    <canvas id="gameCanvas"></canvas>
    <script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

canvas.style.display = 'none';

let isGameRunning = true; // Flag to track game state
let meteors = [];

function startGame() {
    isGameRunning = true;
    document.getElementById('intro').style.display = 'none';
    canvas.style.display = 'block';
    meteors = []; // Reset meteors
    rocket.x = canvas.width / 2 - rocket.width / 2; // Reset rocket position
    // Ensure we only create one spawn timer
    if (!spawnTimer) {
        spawnTimer = setInterval(spawnMeteor, spawnInterval); // Start spawning meteors
    }
    // try to play background music
    safePlay(bgMusic);
    // hide mouse cursor over the canvas while playing
    try { canvas.style.cursor = 'none'; } catch (e) {}
    // Spawn an initial meteor immediately so the player sees activity right away
    spawnMeteor();
    gameLoop();
}

        const rocketImg = new Image();
        rocketImg.src = 'game assets/rocket.png';

        const background = new Image();
        background.src = 'game assets/background.png';
        
        canvas.width = 900;
canvas.height = 700;

        

        const meteorImg = new Image();
        meteorImg.src = 'game assets/meteor.png';

        // Audio assets
    const bgMusic = new Audio('game assets/background_music.mp3');
    bgMusic.loop = true;
    const laserSound = new Audio('game assets/laserSound.wav');
    const meteorBlowUp = new Audio('game assets/meteorBlowUp.wav');
    const bigMeteorBlowUp = new Audio('game assets/bigMeteorBlowUp.mp3');
    const gameOverSound = new Audio('game assets/gameOver.wav');
    const rocketThrust = new Audio('game assets/rocketThrust.wav');
    rocketThrust.loop = true;
    // Separate looped thrust sound specifically for the massive meteor event (mp3 as requested)
    const rocketThrustLoop = new Audio('game assets/rocketThrust.mp3');
    rocketThrustLoop.loop = true;

        function safePlay(audio, restart = true) {
            if (!audio) return;
            try {
                if (restart) audio.currentTime = 0;
                const p = audio.play();
                if (p && p.catch) p.catch(() => {});
            } catch (e) {
                // ignore play errors (autoplay restrictions, etc.)
            }
        }

        const rocket = {
            x: canvas.width / 2 - 25,
            y: canvas.height - 100,
            width: rocketImg.width,
            height: rocketImg.height,
            speed: 10
        };

        rocket.width = 60;
rocket.height = 75;
rocket.x = canvas.width / 2 - rocket.width / 2;
rocket.y = canvas.height - rocket.height - 20;

        let spawnInterval = 1000; // Initial spawn interval in milliseconds

        function spawnMeteor() {
            // Do not spawn regular meteors while the massive meteor event is active
            if (massiveMeteorActive) return;

            const size = 30 + Math.random() * 70; // Random size between 30 and 100
            const meteor = {
                x: Math.random() * (canvas.width - size),
                y: Math.random() * -canvas.height,
                width: size,
                height: size,
                speed: 3 + Math.random() * 2
            };
            meteors.push(meteor);
        }

        function adjustSpawnRate() {
            spawnInterval = Math.max(200, 1000 - score * 10); // Decrease interval as score increases
            // Only update the timer if it already exists (prevents accidental clears when not running)
            if (spawnTimer) {
                clearInterval(spawnTimer);
                spawnTimer = setInterval(spawnMeteor, spawnInterval);
            }
        }

        // Start without a spawn timer; it will be created when the player clicks Start
        let spawnTimer = null;
        setInterval(adjustSpawnRate, 1000); // Adjust spawn rate every second

        function drawRocket() {
            ctx.drawImage(rocketImg, rocket.x, rocket.y, rocket.width, rocket.height);
        }

        function drawMeteors() {
            meteors.forEach(meteor => {
                ctx.drawImage(meteorImg, meteor.x, meteor.y, meteor.width, meteor.height);
            });
        }

        let score = 0;

        let gameWon = false; // flag to prevent repeated win handling

        function checkWin() {
            if (gameWon) return;
            if (score >= 200) {
                gameWon = true;
                // Stop game actions
                isGameRunning = false;
                try { if (spawnTimer) { clearInterval(spawnTimer); spawnTimer = null; } } catch (e) {}
                // stop sounds
                try { bgMusic.pause(); bgMusic.currentTime = 0; } catch (e) {}
                try { rocketThrust.pause(); rocketThrust.currentTime = 0; } catch (e) {}
                try { rocketThrustLoop.pause(); rocketThrustLoop.currentTime = 0; } catch (e) {}
                try { laserSound.pause(); laserSound.currentTime = 0; } catch (e) {}
                try { meteorBlowUp.pause(); meteorBlowUp.currentTime = 0; } catch (e) {}
                try { bigMeteorBlowUp.pause(); bigMeteorBlowUp.currentTime = 0; } catch (e) {}

                // display win message
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '40px Orbitron';
                ctx.fillStyle = 'white';
                ctx.textAlign = 'center';
                ctx.fillText('You beat the game', canvas.width / 2, canvas.height / 2 - 20);
                ctx.font = '20px Orbitron';
                ctx.fillText('(for now â€” will be updates)', canvas.width / 2, canvas.height / 2 + 20);
                try { canvas.style.cursor = 'auto'; } catch(e) {}
            }
        }

function drawScore() {
    ctx.font = '24px Orbitron';
    ctx.fillStyle = 'white';
    ctx.textAlign = 'left';
    ctx.fillText(`Score: ${score}`, 20, 40);
}

        function endGame() {
            isGameRunning = false; // Stop the game loop
            // Stop all audio and play game over sound
            try { bgMusic.pause(); bgMusic.currentTime = 0; } catch(e) {}
            try { rocketThrust.pause(); rocketThrust.currentTime = 0; } catch(e) {}
            try { rocketThrustLoop.pause(); rocketThrustLoop.currentTime = 0; } catch(e) {}
            try { laserSound.pause(); laserSound.currentTime = 0; } catch(e) {}
            try { meteorBlowUp.pause(); meteorBlowUp.currentTime = 0; } catch(e) {}
            try { bigMeteorBlowUp.pause(); bigMeteorBlowUp.currentTime = 0; } catch(e) {}
            try { safePlay(gameOverSound); } catch(e) {}
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = '48px Orbitron';
            ctx.fillStyle = 'white';
            ctx.textAlign = 'center';
            ctx.fillText('Game Over', canvas.width / 2, canvas.height / 2 - 50);
            try { canvas.style.cursor = 'auto'; } catch(e) {}

            const buttonContainer = document.createElement('div');
            buttonContainer.style.textAlign = 'center';
            buttonContainer.style.marginTop = '20px';
            buttonContainer.style.position = 'absolute';
            buttonContainer.style.top = '50%';
            buttonContainer.style.left = '50%';
            buttonContainer.style.transform = 'translate(-50%, -50%)';

            const playAgainButton = document.createElement('button');
            playAgainButton.textContent = 'Play Again';
            playAgainButton.className = 'cta';
            playAgainButton.style.margin = '10px';
            playAgainButton.onclick = () => {
                score = 0; // Reset score
                meteors = []; // Clear all meteors
                massiveMeteor = null; // Clear the massive meteor if active
                massiveMeteorActive = false; // Reset the massive meteor flag
                massiveMeteorHits = 0; // Reset massive meteor hit count
                isGameRunning = true; // Restart the game loop
                rocket.x = canvas.width / 2 - rocket.width / 2; // Reset rocket position to center
                rocket.y = canvas.height - rocket.height - 20; // Reset rocket position vertically
                Object.keys(keys).forEach(key => keys[key] = false); // Clear all key states
                spawnInterval = 1000; // Reset spawn interval to initial value
                try { if (spawnTimer) { clearInterval(spawnTimer); spawnTimer = null; } } catch(e) {}
                if (!spawnTimer) spawnTimer = setInterval(spawnMeteor, spawnInterval);
                // spawn one meteor immediately after restart so the player sees activity
                spawnMeteor();
                document.body.removeChild(buttonContainer);
                startGame();
            };

            const mainPageButton = document.createElement('button');
            mainPageButton.textContent = 'Return to Main Page';
            mainPageButton.className = 'cta';
            mainPageButton.style.margin = '10px';
            mainPageButton.onclick = () => window.location.href = 'index.html';

            const leaderboardButton = document.createElement('button');
            leaderboardButton.textContent = 'See Leaderboard';
            leaderboardButton.className = 'cta';
            leaderboardButton.style.margin = '10px';
            leaderboardButton.onclick = () => window.location.href = 'leaderboard.html';

            buttonContainer.appendChild(playAgainButton);
            buttonContainer.appendChild(mainPageButton);
            buttonContainer.appendChild(leaderboardButton);

            document.body.appendChild(buttonContainer);

            const playerName = prompt('Enter your name:') || 'Anonymous';
            const leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
            leaderboard.push({ player: playerName, score });
            leaderboard.sort((a, b) => b.score - a.score);
            localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
            try { bgMusic.pause(); bgMusic.currentTime = 0; } catch(e) {}
            try { rocketThrust.pause(); rocketThrust.currentTime = 0; } catch(e) {}
        }

        let speedMultiplier = 1; // Multiplier to increase meteor speed over time

        function updateMeteors() {
            if (!massiveMeteorActive && score > 0 && score % 50 === 0) {
        spawnMassiveMeteor();
    }

    meteors.forEach((meteor, index) => {
        meteor.y += meteor.speed * speedMultiplier; // Apply speed multiplier
        if (meteor.y > canvas.height) {
            meteors.splice(index, 1);
            score += 1; // Increase score when a meteor passes
            checkWin();
        }

        // Collision detection
        if (
            rocket.x < meteor.x + meteor.width &&
            rocket.x + rocket.width > meteor.x &&
            rocket.y < meteor.y + meteor.height &&
            rocket.y + rocket.height > meteor.y
        ) {
            endGame();
            return;
        }
    });

    // Gradually increase speed multiplier as score increases
    speedMultiplier = 1 + score / 50;
}

        function moveRocket() {
                    let moving = false;
                    if (keys.ArrowLeft && rocket.x > 0) {
                        rocket.x -= rocket.speed;
                        moving = true;
                    }
                    if (keys.ArrowRight && rocket.x < canvas.width - rocket.width) {
                        rocket.x += rocket.speed;
                        moving = true;
                    }
                    if (moving) {
                        safePlay(rocketThrust, false);
                    } else {
                        try { rocketThrust.pause(); rocketThrust.currentTime = 0; } catch(e) {}
                    }
        }

        const keys = {};
        window.addEventListener('keydown', e => {
            keys[e.key] = true;
        });
        window.addEventListener('keyup', e => {
            keys[e.key] = false;
        });

        function drawBackground() {
    ctx.fillStyle = 'black';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    stars.forEach(star => {
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
        ctx.fill();
    });
}

        let stars = Array.from({ length: 100 }, () => ({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height,
            radius: Math.random() * 2
        }));

        let massiveMeteor = null; // Object to represent the massive meteor
let massiveMeteorActive = false; // Flag to track if the massive meteor event is active
let massiveMeteorHitsRequired = 10; // Initial hits required to destroy the massive meteor

function spawnMassiveMeteor() {
    // Determine meteor image aspect ratio (use natural sizes if available)
    let imgW = meteorImg.naturalWidth || meteorImg.width || 1;
    let imgH = meteorImg.naturalHeight || meteorImg.height || 1;
    const canvasRatio = canvas.width / canvas.height;
    const imgRatio = imgW / imgH;

    let width, height;
    // Fit the meteor to the canvas without stretching: cover the canvas while preserving aspect ratio
    if (imgRatio > canvasRatio) {
        // image is wider than canvas ratio -> match height
        height = canvas.height;
        width = height * imgRatio;
    } else {
        // image is taller (or equal) -> match width
        width = canvas.width;
        height = width / imgRatio;
    }

    massiveMeteor = {
        x: (canvas.width - width) / 2, // center horizontally
        y: -height, // start above the canvas by its height
        width,
        height,
        speed: 1 // Very slow speed for dramatic effect
    };
    massiveMeteorActive = true;
    // Pause regular meteor spawning while the massive meteor is active
    try { if (spawnTimer) { clearInterval(spawnTimer); spawnTimer = null; } } catch (e) {}
    // Start the massive-meteor thrust loop sound
    try { safePlay(rocketThrustLoop); } catch (e) {}
    // Stop the regular short thrust sound if playing
    try { rocketThrust.pause(); rocketThrust.currentTime = 0; } catch (e) {}
}

function drawMassiveMeteor() {
    if (massiveMeteor) {
        ctx.drawImage(
            meteorImg, // Use the regular meteor texture
            massiveMeteor.x,
            massiveMeteor.y,
            massiveMeteor.width,
            massiveMeteor.height
        );
    }
}

function updateMassiveMeteor() {
    if (massiveMeteor) {
        massiveMeteor.y += massiveMeteor.speed;

        // Check for collision with the rocket
        if (
            rocket.x < massiveMeteor.x + massiveMeteor.width &&
            rocket.x + rocket.width > massiveMeteor.x &&
            rocket.y < massiveMeteor.y + massiveMeteor.height &&
            rocket.y + rocket.height > massiveMeteor.y
        ) {
            endGame();
            return;
        }

        // If the massive meteor leaves the screen, resume regular meteors
        if (massiveMeteor.y > canvas.height) {
            massiveMeteor = null;
            massiveMeteorActive = false;
            spawnTimer = setInterval(spawnMeteor, spawnInterval); // Resume regular meteor spawning
        }
    }
}

let laser = null; // Object to represent the laser
let massiveMeteorHits = 0; // Track hits on the massive meteor

// Updated the `shootLaser` function to allow firing the laser at any time.
function shootLaser() {
    if (!laser) {
        laser = {
            x: rocket.x + rocket.width / 2 - 2, // Center the laser on the rocket
            y: rocket.y,
            width: 4,
            height: 20,
            speed: 35 // Increased speed
        };
        safePlay(laserSound);
    }
}

function drawLaser() {
    if (laser) {
        ctx.fillStyle = 'orange'; // Updated laser color to orange
        ctx.fillRect(laser.x, laser.y, laser.width, laser.height);
    }
}

// Ensure a point is awarded for every meteor destroyed and prevent spacebar scrolling.
function updateLaser() {
    if (laser) {
        laser.y -= laser.speed;

        // Check if the laser hits the massive meteor
        if (
            massiveMeteor &&
            laser.x < massiveMeteor.x + massiveMeteor.width &&
            laser.x + laser.width > massiveMeteor.x &&
            laser.y < massiveMeteor.y + massiveMeteor.height &&
            laser.y + laser.height > massiveMeteor.y
        ) {
            // Process hit
            massiveMeteorHits += 1;
            // remove laser immediately to avoid it being tested again
            laser = null;

            // If we've reached the required hits, destroy the massive meteor in a safe, atomic step
            if (massiveMeteorHits >= massiveMeteorHitsRequired) {
                massiveMeteorHits = 0; // reset counter first
                massiveMeteorActive = false;
                massiveMeteor = null; // clear object so other code stops referencing it
                massiveMeteorHitsRequired *= 2; // schedule increased difficulty

                // safely restart spawn timer
                try {
                    if (spawnTimer) {
                        clearInterval(spawnTimer);
                        spawnTimer = null;
                    }
                } catch (e) {
                    // ignore timer errors
                }
                // Resume spawning after a short delay to let other updates settle
                setTimeout(() => {
                    if (!spawnTimer) spawnTimer = setInterval(spawnMeteor, spawnInterval);
                }, 50);

                // Play big meteor explosion and stop massive thrust loop
                safePlay(bigMeteorBlowUp);
                try { rocketThrustLoop.pause(); rocketThrustLoop.currentTime = 0; } catch(e) {}

                score += 25; // Award 25 points for destroying the massive meteor
                checkWin();
            }
        }

    // If laser was cleared while handling the massive meteor, stop to avoid null access
    if (!laser) return;

    // Check if the laser hits any regular meteor
        for (let i = 0; i < meteors.length; i++) {
            const meteor = meteors[i];
            if (
                laser.x < meteor.x + meteor.width &&
                laser.x + laser.width > meteor.x &&
                laser.y < meteor.y + meteor.height &&
                laser.y + laser.height > meteor.y
            ) {
                meteors.splice(i, 1); // Remove the meteor
                score += 2; // Award 2 points for destroying a regular meteor with a laser
                checkWin();
                safePlay(meteorBlowUp);
                laser = null; // Remove the laser after a hit
                break; // Exit the loop after a hit
            }
        }

        // Remove the laser if it goes off-screen
        if (laser && laser.y + laser.height < 0) {
            laser = null;
        }
    }
}

// Prevent the spacebar from scrolling the webpage
window.addEventListener('keydown', (e) => {
    if (e.code === 'Space') {
        e.preventDefault(); // Prevent default scrolling behavior
        shootLaser();
    }
});

// Update the game loop to include the laser
function gameLoop() {
    if (!isGameRunning) return;
    try {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawBackground();
        drawRocket();
        drawMeteors();
        drawMassiveMeteor(); // Draw the massive meteor if active
        drawLaser(); // Draw the laser if active
        drawScore();
        updateMeteors();
        updateMassiveMeteor(); // Update the massive meteor if active
        updateLaser(); // Update the laser if active
        moveRocket();
    } catch (err) {
        // If something unexpected happens, stop the game loop safely and report to console
        console.error('Game loop error:', err);
        isGameRunning = false;
        return;
    }

    requestAnimationFrame(gameLoop);
}

// Added a block for mobile devices
if (/Mobi|Android/i.test(navigator.userAgent)) {
    document.body.innerHTML = '<h1 style="color: red; text-align: center; margin-top: 20%;">This game is not compatible with mobile devices. Please use a desktop browser.</h1>';
}
    </script>

    <footer style="text-align: center; margin-top: 40px; font-family: 'Asimovian', Arial, sans-serif; color: var(--light);">
        Created by the Meteors 12845 in 2025
    </footer>
</body>
</html>